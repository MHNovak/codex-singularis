const e=!0,t=document.location.origin+"/assets/data",n=["wh40k","wh40k-killteam","warhammer-age-of-sigmar","horus-heresy","gaslands","aeronautica-imperialis"],o=document.location.origin+"/assets/data/catpkg-gallery.json";var i,r,s={prom:[]},c={name:""},l={name:"New Roster",game:"",forces:{},conditions:{}};const a=["xmlns","battleScribeVersion","readme","comment","catalogueLinks"],d=["id","name","revision","authorName","authorContact","authorUrl","library","gameSystemId","gameSystemRevision"],p=["costTypes","profileTypes","characteristicTypes","rules","infoLinks","costLimits","publications","forceEntries","categoryEntries"],f=["sharedSelectionEntries","sharedSelectionEntryGroups","sharedRules","sharedProfiles","sharedInfoGroups","categoryEntries"],u=["entryLinks","selectionEntries"],y=["publications","costTypes","profileTypes","characteristicTypes","categoryEntries","modifiers","conditions","repeats","constraints","conditionGroups","forceEntries","categoryLinks","rules","entryLinks","sharedSelectionEntries","profiles","characteristics","selectionEntries","costs","infoLinks","selectionEntryGroups","modifierGroups","sharedSelectionEntryGroups","sharedRules","sharedProfiles","catalogueLinks","forces","selections","categories","costLimits","sharedInfoGroups","infoGroups"],m=["readme","description","comment"],g="bi-text-left",h="bi-people-fill",k="bi-person-fill",E="bi-exclamation-diamond-fill",b="bi-exclamation-diamond",I={"bi-caret-right-fill":"collapse","bi-caret-down-fill":"collapse","bi-x-lg":"remove","bi-info-circle":"info","bi-plus-lg":"add"},L=5;var v,S,x={},j={left:{},center:{},errors:{}},C={};function O(){}function G(e){document.getElementById("lp").classList.add("slide-off"),document.getElementById("rp").classList.add("slide-off"),document.getElementById(e).classList.remove("slide-off")}async function B(){qe("i-inv");let n=document.getElementById("gameSelect").value;const o=n.split("/")[0],s=n.split("/")[1];if(s!==l.game&&"unselected"!==n)if(l.game=s,l.repo=o,e){const e=i.repositories.filter((e=>e.name===o))[0].gamesystemData.filter((e=>e.id===s))[0];r=Oe([t,o,"fileIndex.json"].join("/")),a=[t,o,e.filename].join("/"),c=fetch(encodeURI(a)).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((e=>Ce(e.children[0]))).catch(console.log),document.getElementById("LP-header-title").textContent=e.name,document.getElementById("LP-header-subtitle").textContent=" - v"+e.rev}else c=await Oe(wh40kURI),r=await Oe(wh40kIndex),document.getElementById("LP-header-title").textContent=c.name,document.getElementById("LP-header-subtitle").textContent=" - v"+c.revision;var a;qe("gameSelectForm"),Fe("LP-inner-header"),Fe("CP-inner-header"),Fe("addForceInitial"),document.getElementById("rosterAddForce").disabled=!1,document.getElementById("CP:header").addEventListener("click",H),document.getElementById("LP:header").addEventListener("click",H)}async function P(t){t.preventDefault(),qe("addForceInitial"),qe("left-menu"),Fe("addForceForm"),qe("gameSelectForm"),document.getElementById("rosterAddForce").classList.remove("force-open"),document.getElementById("addForceHint").classList.remove("force-open");let n='<option value="-1">Select faction..</option>';const o=Object.values(l.forces).length>0;let i;if(o){const e=Object.values(l.forces);i=e[e.length-1].catalogue.id}if(e){r=await r;const e=Object.values(r).filter((e=>e.gst==l.game&&!e.isLibrary));e.sort(Te),e.forEach((e=>{n+='<option value="'+e.id+'"',o&&e.id===i&&(n+=" selected"),n+=">"+e.name+"</option>"}))}else for(let e=0;e<r.length;e++)"true"!==r[e].isLibrary&&(n+='<option value="'+e+'">'+r[e].name.split(".cat")[0]+"</option>");document.getElementById("forceFaction").innerHTML=n,async function(){const e="Roster";let t="<option selected>Select type..</option>";if(document.getElementById("forceType").innerHTML=t,"Roster"!==e){l.forces.filter((t=>t.id===e))[0].gstLink.forceEntries.forEach((e=>{"true"!==e.hidden&&(t+='<option value="'+e.id+'">'+e.name+"</option>")}))}else(c=await c).forceEntries.forEach((e=>{0===e.name.split(/\s*/).join("").length&&(e.name="Default"),t+='<option value="'+e.id+'">'+e.name+"</option>"}));document.getElementById("forceType").innerHTML=t,F()}()}function F(){let n=document.getElementById("submitForceBtn"),o=document.getElementById("forceType").value,i=document.getElementById("forceFaction").value;e&&"-1"!==i&&r[i].fullImport.forEach((e=>{let n=e.id;n in s||s.prom.push(Ge([t,l.repo,r[n].filename].join("/")).then((e=>{s[n]=JSON.stringify(Be(e))})).catch(console.log))})),n.disabled="Select type.."===o||"-1"===i}function q(e){e.preventDefault(),qe("addForceForm"),Fe("left-menu"),0===Object.keys(l.forces).length&&(Fe("addForceInitial"),document.getElementById("rosterAddForce").classList.add("force-open"),document.getElementById("addForceHint").classList.add("force-open"))}async function w(n){n.preventDefault(),console.time("submitForce"),qe("addForceForm"),Fe("left-menu");const o=document.getElementById("forceType").value;let i=document.getElementById("forceFaction").value;e||(i=parseInt(i));r[i].name;const y=Pe(6);let m={id:y,name:"",typeId:o,collapse:!1,forces:{},selections:{},conditions:{},modifiers:{}},g=l,h=c;let k=h.forceEntries.filter((e=>e.id===o))[0];m.gstLink=k,m.name=k.name,g.forces[y]=m,j.left[y]={collapse:!1},j.center[y]={collapse:!1};for(const e in l.forces)l.forces[e].collapse=!0,j.left[e].collapse=!0;m.collapse=!1,j.left[y].collapse=!1,j.left[y].uncategorized={collapse:!0},j.center[y].uncategorized={collapse:!0},m.gstLink.categoryLinks&&(m.gstLink.categoryLinks.forEach((e=>{j.left[y][e.targetId]={collapse:!0},j.center[y][e.targetId]={collapse:!1}})),j.left[y][m.gstLink.categoryLinks[0].targetId].collapse=!1);try{m.catalogue=await async function(n,o){const i=r[n].id;var y={};if(e){await Promise.all(s.prom);let e=[];r[i].fullImport.forEach((n=>{const o=n.id;y[o]={importRoot:n.importRoot},o in s?y[o].data=JSON.parse(s[o]):e.push(Ge([t,l.repo,r[o].filename].join("/")).then((e=>{s[o]=e,y[o].data=Be(e)})).catch(console.log))})),y.gst={importRoot:!0,name:c.name,data:JSON.parse(JSON.stringify(c))},await Promise.all(e)}else{y={[i]:{name:r[n].name.split(".cat")[0],importRoot:!0,indexLink:r[n]}};let e=!0;for(;e;)e=!1,Object.keys(y).forEach((t=>{y[t].indexLink.linked.forEach((t=>{t.targetId in y?"true"===t.importRoot&&(y[t.targetId].importRoot=!0):(e=!0,y[t.targetId]={importRoot:"true"===t.importRoot,name:t.name,indexLink:r.filter((e=>e.id===t.targetId))[0]})}))}));y[i].indexLink.linked.forEach((e=>{y[e.targetId].importRoot="true"===e.importRoot}));let o=[];Object.keys(y).forEach((e=>{e in s?y[e].data=JSON.parse(s[e]):o.push(Ge(t+y[e].name+".cat.json").then((t=>{s[e]=t,y[e].data=JSON.parse(t)})).catch(console.log))})),y.gst={importRoot:!0,name:c.name,data:JSON.parse(JSON.stringify(c))},await Promise.all(o)}let m={};d.forEach((e=>{m[e]=y[i].data[e]})),m.sources={},m.root={},m.index={};Object.keys(y).forEach((e=>{const t=y[e].data;m.sources[e]=t.name,Object.keys(t).forEach((e=>{0==d.filter((t=>t===e)).length&&0==p.filter((t=>t===e)).length&&0==f.filter((t=>t===e)).length&&0==u.filter((t=>t===e)).length&&0==a.filter((t=>t===e)).length&&console.log("unexpected root tag: "+e)})),p.forEach((e=>{we(t[e])&&(we(m[e])||(m[e]={}),t[e].forEach((t=>{"false"!==t.import&&(m[e][t.id]=t)})))})),f.forEach((n=>{we(t[n])&&t[n].forEach((t=>{"false"!==t.import&&(t.source=e,m.index[t.id]=t)}))}))})),Object.keys(y).forEach((e=>{const t=y[e].data;y[e].importRoot&&u.forEach((n=>{we(t[n])&&t[n].forEach((n=>{v=n,t;let o=[];we(n.categoryLinks)&&(o=n.categoryLinks.filter((e=>"true"===e.primary)));let r=o.length>0;if(n.targetId&&m.index[n.targetId]){let e=m.index[n.targetId];if(n.name=e.name,!r&&e.categoryLinks){let t=e.categoryLinks.filter((e=>"true"===e.primary))[0];we(t)&&(r=!0,o[0]=t)}}("true"===n.import||e===i)&&(r&&(n.primeCtg=o[0].targetId),n.source=e,m.root[n.id]=n)}))}))})),m,S=0;const g=o.id;C[g]={};for(let e in m.root)K(m,m.root[e],g);return console.log("linked "+S+" entries"),m,m}(i,m),oe(m,1),Z(y,!0),function(e){let t=l.forces[e];be(t.gstLink,t,!0),be(t.gstLink,t,!1),t.gstLink.categoryLinks.forEach((e=>{be(e,t,!0),be(e,t,!1)})),Object.values(t.catalogue.categoryEntries).forEach((e=>{be(e,t,!0),be(e,t,!1)}));for(const e in t.catalogue.root)be(t.catalogue.root[e],t,!0),t.catalogue.root[e].link&&be(t.catalogue.root[e].link,t,!0)}(y),me({scope:"force",rosLink:m})}catch(e){console.log(e)}T(),G("cp"),Fe("LP-return"),console.timeEnd("submitForce"),await new Promise((e=>{setTimeout(e,0)})),function(e){const t=l.forces[e].catalogue;Object.keys(C[e]).forEach((n=>{const o=C[e][n];let i=!1;for(const e in t.root){if(i=W(t.root[e],n),i)break}if(!i)for(const e in t.index){if(i=W(t.index[e],n),i)break}i?(t.index[n]=i,o.link=t.index[n]):console.log("failed to find "+o.name+", type: "+o.type)}))}(y)}function T(){!function(){function e(t){let n={};const o=t.forces&&!t.catalogue,i=t.catalogue;o||i||(n=pe(t.link,t),Object.keys(n).forEach((e=>{n[e].value*=t.quantity??1}))),Object.values(t.forces??{}).forEach((t=>{e(t),je(n,t.costs)})),Object.values(t.selections??{}).forEach((t=>{e(t),je(n,t.costs)})),t.costs=n}e(l)}(),M(),function(){let e=document.getElementById("center-menu"),t=document.createDocumentFragment();e.replaceChildren();for(const e in l.forces){const n=l.forces[e];let o=0;let i=Q(t,{collapsable:!0,collapse:j.center[e].collapse,title:n.catalogue.name,subtitle:le(n.gstLink,n),id:"CP:"+n.id,classes:["force"],icons:[{type:"bi-x-lg",click:D}]}),r={uncategorized:{name:"Uncategorized",entries:[],costSubtotal:{}}};n.gstLink.categoryLinks.forEach((e=>{r[e.targetId]={name:le(e,n),entries:[],costSubtotal:{}}}));for(const e in n.selections){const t=n.selections[e],o=ce(t.link,t);o&&o in r&&(r[o].entries.push(t),je(r[o].costSubtotal,t.costs))}o++;const s=o;for(const t in r){const n=r[t],o={id:"CP:"+e+":"+t,collapsable:!0,collapse:j.center[e][t].collapse,title:n.name,classes:["category","indent-"+s],cost:Y(n.costSubtotal)};if(n.entries.length>0){let e=Q(i,o);n.entries.forEach((t=>{R(e,t,s-1)}))}}}e.appendChild(t)}(),J()}function M(){let e=document.getElementById("left-menu"),t=document.createDocumentFragment();e.replaceChildren();for(const e in l.forces){const n=l.forces[e];let o=Q(t,{collapsable:!0,collapse:j.left[e].collapse,title:n.catalogue.name,subtitle:le(n.gstLink,n),id:"LP:"+n.id,classes:["force"]});if(j.left[e].collapse)continue;let i={uncategorized:{name:"Uncategorized",entries:[]}};(n.gstLink.categoryLinks??[]).forEach((t=>{const o=se(t,n),r=ie(t,e);o||r||(i[t.targetId]={name:le(t,n),entries:[]})}));for(const t in n.catalogue.root){const o=n.catalogue.root[t],r=se(o,n),s=ie(o,e),c=ce(o,n);c&&c in i&&!r&&!s&&i[c].entries.push(o)}for(const t in i){const r=1,s=i[t],c={id:"LP:"+e+":"+t,collapsable:!0,collapse:j.left[e][t].collapse,title:s.name,classes:["category","indent-"+r]};if(s.entries.length>0){let t=Q(o,c);s.entries.forEach((o=>{let i="none";we(o.type)&&(i=o.type),"selectionEntry"===i&&(i=o.link.type);let s=g;"unit"===i?s=h:"model"===i&&(s=k);const c=r,l={title:le(o,n),id:e+":"+o.id,icons:[{type:"bi-plus-lg",click:U}],iconL:s,classes:["indent-"+c]};Q(t,l)}))}}}e.appendChild(t),0===Object.keys(l.forces).length&&(Fe("addForceInitial"),document.getElementById("rosterAddForce").classList.add("force-open"),document.getElementById("addForceHint").classList.add("force-open"))}function R(e,t,n){let o="none";we(t.link.type)&&(o=t.link.type),"selectionEntry"===o&&t.link.link&&(o=t.link.link.type);let i=g;"unit"===o?i=h:"model"===o&&(i=k);let r="";t.quantity>1&&(r=t.quantity+"x ");let s=!1;we(t.selections)&&Object.keys(t.selections).length>0&&(s=!0);let c=!1;we(t.link.selectionEntries||t.link.selectionEntryGroups||t.link.entryLinks)&&(c=!0),we(t.link.link)&&we(t.link.link.selectionEntries||t.link.link.selectionEntryGroups||t.link.link.entryLinks)&&(c=!0);const l=n>=L?n:n+1;for(const e of Object.values(t.constraints??{})){if(e.map((e=>de(e))).filter((e=>!e.status)).map((e=>se(e.entryLink,t))).some((e=>!e))){i=E;break}}V(t)&&(i=E);let a={title:r+le(t.link,t),id:Me(t).join(":"),icons:[{type:"bi-x-lg",click:D}],iconL:i,classes:["indent-"+l]};if(s){a.collapsable=!0,a.collapse=t.collapse;let e="";Object.keys(t.selections).forEach((n=>{const o=t.selections[n].quantity;e+=", "+(o>1?o+"x ":"")+t.selections[n].name})),a.subtitle=e.substr(2),a.toggleSubtitle=!0}c&&(a.isBold=!0);const d=Q(e,a);s&&Object.keys(t.selections).forEach((e=>{const n=t.selections[e];R(d,n,l)}))}function N(e){const t=A(e);if(t.isForce&&t.leftPanel){const e=j.left[t.fid].collapse;return Object.values(j.left).forEach((e=>{e.collapse=!0})),j.left[t.fid].collapse=!e,void M()}if(e.target.classList.toggle("bi-caret-right-fill"),e.target.classList.toggle("bi-caret-down-fill"),t.node.nextElementSibling.classList.toggle("collapse"),t.isForce&&t.centerPanel?j.center[t.fid].collapse=!j.center[t.fid].collapse:t.link.collapse=!t.link.collapse,t.leftPanel&&t.isCategory){const e='[id="LP:'+t.fid+'"]~div .category',n=document.querySelectorAll(e);for(const e of n){const n=e.id.split(":").pop(),o=j.left[t.fid][n];if(n!==t.id&&!o.collapse){o.collapse=!0,e.nextElementSibling.classList.add("collapse");const t=e.querySelector("i");t.classList.toggle("bi-caret-right-fill"),t.classList.toggle("bi-caret-down-fill")}}}if(t.node.classList.contains("toggle-sub")){document.querySelector('[id="'+t.node.id+'"] .subtitle').classList.toggle("d-none")}}function U(e){e.target;const t=A(e);t;fe({entry:t.link,parent:l.forces[t.fid]}),G("cp"),T()}function D(e){e.target;ye(A(e).link);!we(x.id)||Re(Me(x))||(qe("rp-all"),x={}),T()}function H(e){if(e.preventDefault(),e.target.classList.contains("bi-x-lg"))return;if(e.target.classList.contains("list-toggle"))return;if(e.target.classList.contains("bi-plus-lg"))return;let t=e.target;for(;!t.classList.contains("list-group-item");){if(t.classList.contains("btn"))return;t=t.parentElement}const n=t.id;for(;!t.classList.contains("list-group-root");)t=t.parentElement;if("left-menu"!==t.id)if("center-menu"===t.id){if(!we(n)||0===n.length)return;let e=Re(n.split("CP:").join(""));x.id&&x.id===e.id||(x=e,j.errors.collapse=!0,J()),x&&G("rp")}else"CP-inner-header"===t.id&&(G("rp"),x=l,J())}function A(e){let t={isForce:!1,isCategory:!1,leftPanel:!1,centerPanel:!1,icon:!1,id:"",fid:"",path:[]},n=e.target;for(;"A"!==n.nodeName&&"BODY"!==n.nodeName;)n=n.parentElement;t.node=n,t.isForce=n.classList.contains("force"),t.isCategory=n.classList.contains("category");for(const e of n.classList)if(e in I){t.icon=I[e];break}let o=n;for(;!o.classList.contains("list-group-root");)o=o.parentElement;if("center-menu"===o.id&&(t.centerPanel=!0),"left-menu"===o.id&&(t.leftPanel=!0),"rp-errors"===o.id)return t.link=j.errors,t;if(we(n.id))if(t.path=n.id.split(/^LP:|^CP:/).join("").split(":"),t.id=n.id.split(":").pop(),t.fid=t.path[0],t.isForce)t.link=l.forces[t.id];else if(t.isCategory){const e=t.leftPanel?j.left:j.center;t.link=e[t.fid][t.id]}else t.leftPanel?t.link=l.forces[t.fid].catalogue.root[t.id]:t.centerPanel&&(t.link=Re(t.path));return t}function z(e,t){let n=document.createElement(e);return we(t)&&("string"==typeof t?n.className=t:t.forEach((e=>{n.classList.add(e)}))),n}function Q(e,t){let n=z("a",["list-group-item","list-group-item-action"]);const o={collapsable:!1,collapse:!1,isBold:!1,href:"#roster",title:"",subtitle:"",toggleSubtitle:!1,classes:[],icons:[],cost:""};Object.keys(o).forEach((e=>{we(t[e])||(t[e]=o[e])})),n.href=t.href,we(t.id)&&(n.id=t.id),t.classes.forEach((e=>{n.classList.add(e)})),n.addEventListener("click",H);let i=n.appendChild(z("div",["d-flex","justify-content-start"]));if(t.collapsable){let e=z("i",["list-toggle","icon-small"]);t.collapse?e.classList.add("bi-caret-right-fill"):e.classList.add("bi-caret-down-fill"),e.addEventListener("click",N),i.appendChild(e)}else i.appendChild(z("i",["icon-small","empty-icon"]));if(we(t.iconL)&&i.appendChild(z("i",[t.iconL,"icon-small"])),t.subtitle.length>0||t.collapsable||t.isBold){let e=i.appendChild(z("div",["d-flex","flex-wrap","flex-shrink-1","text-truncate","align-items-baseline","mr-auto"])),o=e.appendChild(z("div",["pr-1","title"]));if(o.textContent=t.title,t.cost.length>0&&0==t.subtitle.length){e.appendChild(z("div",["cost"])).textContent=t.cost}if(t.subtitle.length>0){o.textContent+=":";let i=e.appendChild(z("div",["subtitle"]));i.textContent=t.subtitle,t.toggleSubtitle&&n.classList.add("toggle-sub"),t.toggleSubtitle&&!t.collapse&&i.classList.add("d-none")}}else{i.appendChild(z("div",["pr-1","mr-auto"])).textContent=t.title}if(t.icons.forEach((e=>{i.appendChild(z("i",e.type)).addEventListener("click",e.click)})),e.appendChild(n),t.collapsable){let e=n.insertAdjacentElement("afterend",z("div","list-group"));return t.collapse&&e.classList.add("collapse"),e}return n}function J(){if(!x.name)return qe("rp-all"),void G("cp");Fe("rp-all"),rosterEntry=x;if(rosterEntry.forces&&!rosterEntry.catalogue)document.getElementById("rp-titletext").innerText=rosterEntry.name;else{rosterEntry.catalogue;const e=rosterEntry.gstLink??rosterEntry.link;document.getElementById("rp-titletext").innerText=le(e,rosterEntry)}qe("rp-stats");const e=document.getElementById("rp-formarea");for(;e.firstChild;)e.removeChild(e.firstChild);let t=ke(rosterEntry.link,rosterEntry,!1);Fe("rp-formarea"),Ee(e,t),function(){const e=x,t=x.forces&&!x.catalogue,n=x.catalogue,o=Ue(x),i=document.getElementById("rp-errors");i.replaceChildren();const r=document.createDocumentFragment();let s=[],c=[];t?c=_(x):Object.values(x.constraints??[]).forEach((e=>{e.forEach((e=>{c.push(e)}))}));c.forEach((t=>{const n=de(t),o=se(t.entryLink,e);n.status||o||s.push(n)}));let a=[];t||(!e.catalogue&&V(e)&&a.push(e.link),Object.values(e.selections??{}).filter((e=>V(e))).forEach((e=>{a.push(e.link)})));a.forEach((e=>{s.push({isHidden:!0,entry:e})})),0===document.querySelectorAll("#rp-formarea input").length&&(j.errors.collapse=!1,qe("rp-formarea"));if(s.length>0){Fe("rp-errors");let p=r;if(s.length>1){const f={title:s.length+" Errors",id:"",collapsable:!0,collapse:j.errors.collapse,iconL:E,classes:["errors"]};p=Q(r,f)}s.forEach((e=>{let t;if(e.isHidden){t=(e.entry.link?.name??e.entry.name)+" is not a valid selection"}else t=("min"===e.link.type?"Minimum ":"Max ")+e.value,"SEG"===e.type&&(t+=" selection"+(e.value>1?"s":"")+" from"),t+=" "+(e.entryLink.link?.name??e.entryLink.name),"category"===e.type&&(t+=" selection"+(e.value>1?"s":"")),t+=" (currently "+e.count+")";Q(p,{title:t,iconL:b,classes:["indent-0","errors"]})})),i.appendChild(r)}else qe("rp-errors");if(t){let u={constraints:0,conditions:0,modifiers:0};function d(e,t){return Object.keys(t).forEach((n=>{Object.values(e[n]??{}).forEach((e=>{t[n]+=e.length}))})),Object.values(e.forces??{}).forEach((e=>{d(e,t)})),Object.values(e.selections??{}).forEach((e=>{d(e,t)})),t}u=d(l,u),document.getElementById("rp-stats").textContent="Tracking "+u.constraints+" constraints, "+u.modifiers+" modifiers, and "+u.conditions+" conditions... so far",u.constraints+u.conditions+u.modifiers>0&&Fe("rp-stats")}if(n){Fe("rp-stats"),document.getElementById("rp-stats").textContent=o.catalogue.name+", v"+o.catalogue.revision}}();let n=Y(x.costs);if(n.length>0){Fe("rp-titlecost");document.getElementById("rp-titlecost").textContent=n}else qe("rp-titlecost")}function V(e){let t=e.link;if(se(t,e))return!0;if(De(e).some((t=>se(t,e))))return!0;const n=ce(t,e);if(n&&"uncategorized"!==n){if(se(Ue(e).gstLink.categoryLinks.filter((e=>e.targetId===n))[0]??{},e))return!0}return!1}function _(e){let t=[];return Object.values(e.constraints??[]).forEach((e=>{e.forEach((e=>{t.push(e)}))})),Object.values(e.forces??{}).concat(Object.values(e.selections??{})).forEach((e=>{t=t.concat(_(e))})),t}function X(){const e=document.getElementById("rp-formarea").children;let t=[];for(let n=0;n<e.length;n++)if(e[n].classList.contains("outer-group"))for(let o=0;o<e[n].children.length;o++){const i=e[n].children[o].children[0];"INPUT"===i.nodeName?t.push(i):console.log("expected to find INPUT element")}t;let n=!1;const o=x.quantity||1,i=/NONE/;t.filter((e=>!i.test(e.id))).forEach((e=>{let t=e.checked+0;if("number"===e.type){t=parseInt(e.value);const n=parseInt(e.max),o=parseInt(e.min);NaN!==n&&t>n&&(t=n,e.value=""+n),NaN!==o&&t<o&&(t=o,e.value=""+o)}const i=e.id,r=x.selections||0;let s,c=!1,l=0;if(r){const e=Object.keys(x.selections).filter((e=>x.selections[e].entryId===i));e.length>0&&(c=!0,s=x.selections[e[0]],e.forEach((t=>{l+=x.selections[e[0]].quantity/o})))}if(c&&t>0&&l!==t&&s.link.merge)ue(s,t*o),n=!0;else if(t>=l){const e=Ne(x.link,i);let r=i.split(":");r.pop(),r=r.join(":");let s={entry:e,parent:x,quantity:(t-l)*o,catPath:r};if(e.merge||t-l==1)fe(s);else{s.quantity=1;for(let e=0;e<t-l;e++)fe(s)}n=!0}else c&&t<=0&&(ye(s),n=!0)})),n&&T()}function Y(e){let t="";if(!e)return t;let n=[];return Object.values(e).forEach((e=>{0!=e.value&&n.push(e.value+e.name)})),t=n.join(", "),t}function K(e,t,n){v=t,we(t.targetId)&&!we(t.link)&&(we(e.index[t.targetId])?(t.link=e.index[t.targetId],K(e,t.link,n)):we(C[n][t.targetId])||(C[n][t.targetId]=t),S++),Object.keys(t).forEach((o=>{we(t[o].length)&&"object"==typeof t[o]&&(o,t[o].forEach((t=>{K(e,t,n)})))}))}function W(e,t){if(e.link)return!1;if(e.id===t)return e;if(e.selectionEntries)for(const n of e.selectionEntries){const e=W(n,t);if(e)return e}if(e.selectionEntryGroups)for(const n of e.selectionEntryGroups){const e=W(n,t);if(e)return e}return!1}function Z(e,t){l.constraints||(l.constraints={});let n=l.forces[e];t&&(n.constraints={}),$(e,n.gstLink,!0,t),n.gstLink.categoryLinks.forEach((n=>{$(e,n,!0,t)}));for(const o in n.catalogue.root)$(e,n.catalogue.root[o],!0,t);for(const o in n.catalogue.index)$(e,n.catalogue.index[o],!1,t)}function $(e,t,n,o){const i=l.forces[e],r=t.targetId??t.id;let s=t.constraints??[];n&&t.link&&t.type&&(s=s.concat(t.link.constraints??[])),s.forEach((s=>{let c={count:0,status:!1,link:s,entryLink:t,isRoot:n&&t.type};we(t.import)?c.type=(t.link??t).type?"SE":"SEG":c.type="category","roster"===s.scope?te(l,r,c):"force"===s.scope?o&&te(i,r,c):s.scope===i.catalogue.id?(console.log("found catalogue id scoped constraint ",t),o&&te(i,r,c)):"primary-catalogue"===s.scope?o&&te(i,r,c):s.scope===i.gstLink.id?(console.log("found forceEntry id scoped constraint ",t),o&&te(i,r,c)):"parent"===s.scope?o&&(n||"category"===c.type)&&te(i,r,c):s.scope in l.forces[e].catalogue.categoryEntries&&console.log("unsupported category scope "+s.scope)})),(t.entryLinks??[]).concat(t.selectionEntries??[]).concat(t.selectionEntryGroups??[]).forEach((t=>{$(e,t,!1,o)}))}function ee(e,t){const n=Ue(e);t.forEach((t=>{const o=t.entry,i=t.constraint,r=o.targetId??o.id;let s={count:0,status:!1,link:i,entryLink:o};if(we(o.import)?s.type=(o.link??o).type?"SE":"SEG":(s.type="category",console.log("unexpected category constraint in child selection")),"parent"===i.scope||i.scope===e.link.id||i.scope===e.link.targetId)te(e,r,s);else if("force"===i.scope);else if("roster"===i.scope);else if(i.scope===n.catalogue.id);else if("primary-catalogue"===i.scope);else if(i.scope===n.gstLink.id);else{let t=!1,n=e;for(;n.parent;)n=n.parent,i.scope!==n.link?.id&&i.scope!==n.link?.targetId||(te(n,r,s),t=!0,console.log("Found ancestral constraint in "+n.name));t||console.log("Unsupported scope: "+i.scope+" in ",o)}}))}function te(e,t,n){const o=n.link;if("string"==typeof o.value&&(o.value=parseInt(o.value),o.includeChildSelections="true"===o.includeChildSelections,o.includeChildForces="true"===o.includeChildForces),e.constraints[t]||(e.constraints[t]=[]),n.rosterScope=e,!(e.constraints[t].filter((e=>e.link.id===o.id)).length>0)){if("roster"===o.scope){const t={scope:"roster",rosterLink:e,id:n.entryLink.id,icf:o.includeChildForces,ics:o.includeChildSelections};n.count=he(t)}n.status=ne(n),e.constraints[t].push(n)}}function ne(e){const t=e.rosterScope.quantity??1,n=e.value??e.link.value;return"min"===e.link.type?e.count/t>=n:"max"===e.link.type?-1===n||e.count/t<=n:void console.log("Unexpected constraint type: "+e.link.type)}function oe(e,t){v=e;const n=Ue(e);let o=e.catalogue||0,i=o?[e.gstLink.id]:[];if(!o){const t=[e.link.id].concat(e.link.targetId??[]);let n=e.entryId.split(":");if(n.pop(),n.length>0){let t=n.shift();t!==e.parent.link.targetId&&n.push(t)}const o=e.link.link?.type??e.link.type,r=(e.link.link?.categoryLinks??[]).map((e=>e.targetId)).concat((e.link.categoryLinks??[]).map((e=>e.targetId))),s=[...new Set(r)];i=[o,"anything"].concat(n).concat(t).concat(s)}i.forEach((o=>{let i=l.constraints?.[o]??[],r=e;for(;r.parent;)r=r.parent,i=i.concat(r.constraints?.[o]??[]);i.forEach((e=>{e,e.count+=t,e.status=ne(e)})),r=e;let s=(l.conditions?.[o]??[]).concat(n.conditions?.[o]??[]);for(;r.parent;)s=s.concat(r.conditions?.[o]??[]),r=r.parent;s.forEach((e=>{e.count+=t;const n=e.status;e.status=Se(e),n!==e.status&&xe(e)}))}))}function ie(e,t){return ae(e,l.forces[t]).remaining<=0}function re(e,t){opts=ke(e,t,!1),e.merge=function e(n){let o=!0;if(n.SEG.forEach((t=>{e(t),o&=t.parentSEG.mergeParent})),n.SE.forEach((e=>{we(e.entry.merge)||re(e.entry,t),o&=e.entry.mergeParent})),!n.parentSEG)return o;n.parentSEG.mergeParent=o}(opts);let n=e.merge,o=(e.constraints??[]).concat(e.link?.constraints??[]);const i=0===o.length;let r=1/0,s=0;o.forEach((e=>{"min"===e.type&&parseInt(e.value)<r&&(r=parseInt(e.value)),"max"===e.type&&parseInt(e.value)>s&&(s=parseInt(e.value))}));const c=r!==s;n&="true"===e.collective||"true"===e.link?.collective||!i&&!c,e.mergeParent=n}function se(e,t){e||console.log("undefined input ",v),v=e;t.catalogue;const n=e.targetId&&e.link,o=!!e.primary,i=Ue(t)??{};let r="true"===e.hidden,s=e.id;o&&(s=e.targetId);let c=t,l=[];for(;c.parent;)l=l.concat((c.modifiers?.[s]??[]).filter((e=>e.status&&"hidden"===e.field))),c=c.parent??c;return l=l.concat((i.modifiers?.[s]??[]).filter((e=>e.status&&"hidden"===e.field))),l.forEach((e=>{r="true"===e.link.value})),n&&!o&&(r|=se(e.link,t)),r}function ce(e,t){v=e;const n=t.catalogue||0,o=e.targetId&&e.link,i=Ue(t)??{};let r=e.primeCtg,s=(i.modifiers?.[e.id]??[]).filter((e=>e.status&&"category"===e.field));return n||(s=s.concat((t.modifiers?.[e.id]??[]).filter((e=>e.status&&"category"===e.field)))),s.forEach((t=>{"set-primary"===t.link.type?r=t.link.value:"unset-primary"===t.link.type?r=void 0:"add"!==t.link.type&&"remove"!==t.link.type&&console.log("Unexpected modifier type "+t.link.type+" in ",e)})),o&&(r=r??se(e.link,t)),r||(r="uncategorized"),r}function le(e,t){t.catalogue;const n=e.targetId&&e.link,o=!!e.primary,i=Ue(t)??{};let r=e.link?.name??e.name,s=e.id;o&&(s=e.targetId);let c=t,l=[];for(;c.parent;)l=l.concat((c.modifiers?.[s]??[]).filter((e=>e.status&&"name"===e.field))),c=c.parent??c;if(l=l.concat((i.modifiers?.[s]??[]).filter((e=>e.status&&"name"===e.field))),l.forEach((e=>{"set"===e.link.type?r=e.link.value:"append"===e.link.type?r=r+" "+e.link.value:console.log("Unexpected modifier operation to name: "+e.link.type)})),n&&!o){const n=le(e.link,t),o=n!==e.link.name;r=o?n:r}return r}function ae(e,t){t.catalogue,e.targetId&&e.link,Ue(t);let n={min:!0,max:!0,minQuant:0,maxQuant:1/0,remaining:1/0};const o=e.targetId??e.id;let i=t,r=l.constraints?.[o]??[];for(;i.parent||i.catalogue;){let e=i.constraints?.[o]??[];r=r.concat(e),i=i.parent??l}return r,r.forEach((e=>{let o=e.link.value;e.modifiers&&e.modifiers.filter((e=>e.status)).forEach((e=>{"increment"===e.link.type?o+=e.repeat:"decrement"===e.link.type?o-=e.repeat:"set"===e.link.type?o=parseInt(e.link.value):console.log("Unexpected modifier type: "+e.link.type)})),-1===o&&"max"===e.link.type&&(o=1/0);const i=e.rosterScope.quantity??1,r=o-e.count/i;"max"===e.link.type?(n.maxQuant=Math.min(n.maxQuant,o),n.max&=e.count/i<=o,n.remaining=Math.min(n.remaining,r)):"min"===e.link.type?(n.minQuant=Math.max(n.minQuant,o),n.min&=e.count>=o*(t.parent?.quantity??1)):console.log("unexpected constraint type "+e.link.type)})),n}function de(e){let t={};Object.keys(e).forEach((n=>{t[n]=e[n]}));let n=e.link.value;return(e.modifiers??[]).filter((e=>e.status)).forEach((t=>{"increment"===t.link.type?n+=t.repeat*parseInt(t.link.value):"decrement"===t.link.type?n-=t.repeat*parseInt(t.link.value):"set"===t.link.type?n=parseInt(t.link.value):console.log("Unexpected constraint modifier type: "+t.link.type),isNaN(n)&&console.log("Found non-numeric constraint in "+e.entryLink.id+", "+e.entryLink.name)})),t.value=n,t.status=ne(t),t}function pe(e,t){t.catalogue;const n=e.targetId&&e.link||0,o=!!e.primary,i=Ue(t)??{},r=e.id;let s={};(e.costs??[]).forEach((e=>{s[e.typeId]={value:parseInt(e.value),name:e.name}}));const c=Object.values(s).some((e=>e.value&&0!==e.value));let l={};(e.link?.costs??[]).forEach((e=>{l[e.typeId]={value:parseInt(e.value),name:e.name},s[e.typeId]||(s[e.typeId]={value:0,name:e.name})}));let a=t,d=[];for(;a.parent;)d=d.concat((a.modifiers?.[r]??[]).filter((e=>e.status&&"cost"===e.fieldType))),a=a.parent??a;if(d=d.concat((i.modifiers?.[r]??[]).filter((e=>e.status&&"cost"===e.fieldType))),d.forEach((t=>{t.field in s||console.log("Unexpected cost type: "+t.field+" in modifier to "+e.id+", "+e.name),"increment"===t.link.type?s[t.field].value+=t.repeat*parseInt(t.link.value):"decrement"===t.link.type?s[t.field].value-=t.repeat*parseInt(t.link.value):"set"===t.link.type?s[t.field].value=parseInt(t.link.value):console.log("Unexpected modifier operation to cost: "+t.link.type)})),n&&!o){const n=s,o=d.length>0,i=pe(e.link,t);let r=!1;Object.keys(i).forEach((e=>{r|=i[e].value!==l[e]?.value})),s=r?i:o||c?n:l}return s}function fe(e){e;const t=Pe(6);let n={entryId:e.entry.id,id:t,name:e.entry.name,link:e.entry,quantity:1,parent:e.parent,collapse:!0};const o=Ue(e.parent);if(e.entry.link&&(n.name=e.entry.link.name),we(e.quantity)){if(e.quantity<1)return;n.quantity=e.quantity}if(we(e.catPath)&&e.catPath.length>0&&(n.entryId=e.catPath+":"+n.entryId),":"!==e.catPath&&":"!==n.entryId.substr(0,1)||console.log('catPath of ":" in '+n.name+", "+e.entry.id),we(e.parent.selections)||(e.parent.selections={}),we(e.entry.merge)||(re(e.entry,o),we(e.parent.catalogue)&&(e.entry.merge=!1)),!e.entry.merge&&n.quantity>1){const t=n.quantity-1;n.quantity=1,e.quantity=1;for(let n=0;n<t;n++)fe(e)}e.parent.selections[t]=n;const i=e.parent.selections[t];oe(n,n.quantity),me({scope:"selection",sid:t,rosLink:i}),e.entry.merge&&function(e){let t=e.parent.selections;function n(e,t){if(e.entryId===t.entryId){if(we(e.selections)&&we(t.selections)){const o=Object.keys(e.selections).sort((e=>e.entryId)),i=Object.keys(t.selections).sort((e=>e.entryId));if(o.length!==i.length)return!1;let r=!0;for(let r=0;r<o.length;r++)if(!n(e.selections[o[r]],t.selections[i[r]]))return!1;return r}return!we(e.selections)&&!we(t.selections)}return!1}for(let o of Object.keys(t).filter((t=>t!==e.id))){let i=t[o];if(n(e,i)){console.log("merging: "+e.name),ue(i,i.quantity+e.quantity),ye(e);break}}}(i),function(e){e.conditions||(e.conditions={});e.modifiers||(e.modifiers={});let t=ke(e.link,e,!1);function n(t){t.SE.forEach((t=>{be(t.entry,e,!0),t.entry.link&&be(t.entry.link,e,!0),t.pathEntry&&t.path!==e.link.targetId&&be(t.pathEntry,e,!0)})),t.parentSEG&&be(t.parentSEG,e,!0),t.pathEntry&&!o[t.path]&&t.path!==e.link.targetId&&(be(t.pathEntry,e,!0),o[t.path]=!0),t.SEG.forEach((e=>{n(e)}))}t;let o={};n(t),be(e.link,e,!1),e.link.targetId&&e.link.link&&be(e.link.link,e,!1);e.link.targetId&&!e.link.link&&console.log("getChildPreviewMods: entry has targetId but not link, ",e);De(e).forEach((t=>{be(t,e,!1)}))}(i)}function ue(e,t){const n=e.quantity;e.quantity=t,oe(e,t-n),e.selections&&Object.keys(e.selections).forEach((o=>{let i=e.selections[o];const r=i.quantity/n;ue(i,t*r)}))}function ye(e){if(function e(t){Object.values(t.selections??{}).forEach((t=>{e(t)})),oe(t,-1*t.quantity)}(e),e.catalogue){const t=e.id;delete l.forces[t],delete j.left[t],delete j.center[t],delete l.constraints,Object.keys(l.forces).forEach((e=>{Z(e,!1)}))}else delete e.parent.selections[e.id]}function me(e){if("force"===e.scope){const t=e.rosLink;Object.values(l.constraints).concat(Object.values(t.constraints)).forEach((e=>{e.forEach((e=>{!e.status&&e.isRoot&&"SE"===e.type&&"min"===e.link.type&&fe({entry:e.entryLink,quantity:e.link.value-e.count,parent:t})}))}))}else if("selection"===e.scope){let t=e.rosLink,n={SE:[],SEG:[]};ge({entry:t.link,path:"",type:"root"},n),t.constraints={},ee(t,n.SE),ee(t,n.SEG),n.SE.forEach((e=>{if("parent"===e.constraint.scope&&"min"===e.constraint.type){const n=e.entry.targetId??e.entry.id;t.constraints[n].filter((e=>"min"===e.link.type)).forEach((n=>{const o=(n.link.value-n.count)*t.quantity;fe({entry:n.entryLink,quantity:o,parent:t,catPath:e.path})}))}})),n.SEG.forEach((e=>{let n=0;if(e.entry.defaultSelectionEntryId?n=e.entry.defaultSelectionEntryId:e.entry.link?.defaultSelectionEntryId&&(n=e.entry.link?.defaultSelectionEntryId),"min"===e.constraint.type&&n){const o=e.entry.targetId??e.entry.id;let i=(e.entry.selectionEntries??[]).concat(e.entry.entryLinks??[]).concat(e.entry.link?.selectionEntries??[]).concat(e.entry.link?.entryLinks??[]).filter((e=>e.id===n));1===i.length?(i=i[0],(t.constraints[o]??[]).filter((e=>"min"===e.link.type)).forEach((n=>{const o=(n.link.value-n.count)*t.quantity;let r=e.path+":"+e.entry.id+(e.entry.targetId?":"+e.entry.targetId:"");":"===r.substr(0,1)&&(r=r.substr(1)),fe({entry:i,quantity:o,parent:t,catPath:r})}))):console.log("Found "+i.length+" matches of defaultId "+n+" in SEG "+e.entry.id+" ("+e.entry.name+")")}}))}}function ge(e,t){const n=e.entry;v=e.entry;let o="";"root"!==e.type&&(o=0===e.path.length?n.id:e.path+":"+n.id),"SEG"===e.type&&we(n.constraints)&&n.constraints.forEach((o=>{t.SEG.push({path:e.path,entry:n,constraint:o})}));let i=n.selectionEntries??[];we(n.entryLinks)&&(i=i.concat(n.entryLinks.filter((e=>"selectionEntry"===e.type)))),i.filter((e=>we(e.constraints))).forEach((e=>{e.constraints.forEach((n=>{t.SE.push({path:o,entry:e,constraint:n})}))})),i.filter((e=>we(e.link)&&we(e.link.constraints))).forEach((e=>{e.link.constraints.forEach((n=>{t.SE.push({path:o,entry:e,constraint:n})}))}));let r=n.selectionEntryGroups??[];if(we(n.entryLinks)&&(r=r.concat(n.entryLinks.filter((e=>"selectionEntryGroup"===e.type)))),r.forEach((e=>{ge({entry:e,path:o,type:"SEG"},t)})),we(n.link)){let e="selectionEntryGroup"===n.type?"SEG":"SE";ge({entry:n.link,path:o,type:e},t)}return t}function he(e){let t=0;if(we(e.type)||(e.type="SE"),"roster"===e.scope)return Object.keys(l.forces).forEach((n=>{e.rosterLink=l.forces[n],e.scope="force",t+=he(e)})),t;let n=e.rosterLink;const o=n.link??{},i=Ue(n);"force"===e.scope||e.scope===i.catalogue.id||e.scope===i.gstLink.id?n=i:"parent"===e.scope||e.scope===o.id||e.scope===o.targetId||"self"===e.scope||"custom"!==e.scope&&(console.log("encountered custom scope "+e.scope+" in "+n.id),e.scopeId=e.scope,e.scope="custom");for(const o in n.selections??{}){const i=n.selections[o],r=n.selections[o].link,s=r.link?.type??r.type;if(r.id===e.id||r.targetId===e.id)t+=i.quantity;else if(s===e.id||"anything"===e.id)t+=i.quantity;else{if(i.entryId.split(":").some((t=>t===e.id))&&e.id!==i.parent.link.targetId)t+=i.quantity;else{(r.categoryLinks??[]).concat(r.link?.categoryLinks??[]).some((t=>t.targetId===e.id))&&(t+=i.quantity)}}if(e.ics){const n={scope:"parent",rosterLink:i,id:e.id,icf:e.ics,ics:e.icf};t+=he(n)}}return e.id===i.typeId&&t++,t}function ke(e,t,n){let o={SE:[],SEG:[],rosterEntry:t};if(!we(e))return o;let i,r="",s=[],c=[],l=[];e.link&&(s=e.entryLinks??[],c=e.selectionEntries??[],l=e.selectionEntryGroups??[],e=e.link,r=e.id,i=e);let a=e.entryLinks??[];n&&(a=a.filter((e=>!se(e,t))),s=s.filter((e=>!se(e,t)))),a=a.map((e=>({path:r,entry:e,pathEntry:i}))),a=a.concat(s.map((e=>({path:"",entry:e}))));let d=e.selectionEntries??[];n&&(d=d.filter((e=>!se(e,t))),c=c.filter((e=>!se(e,t)))),d=d.map((e=>({path:r,entry:e,pathEntry:i}))),d=d.concat(c.map((e=>({path:"",entry:e})))),o.SE=d.concat(a.filter((e=>"selectionEntry"===e.entry.type)));let p=e.selectionEntryGroups??[];return n&&(p=p.filter((e=>!se(e,t))),l=l.filter((e=>!se(e,t)))),p=p.map((e=>({path:r,entry:e,pathEntry:i}))),p=p.concat(l.map((e=>({path:"",entry:e})))),p=p.concat(a.filter((e=>"selectionEntryGroup"===e.entry.type))),p.forEach((e=>{let i=ke(e.entry,t,n);i.path=e.path,i.pathEntry=e.pathEntry,i.parentSEG=e.entry,o.SEG.push(i)})),o}function Ee(e,t){let n={title:"",children:[]};if(t.SE.sort(Te),t.parentMin=we(t.parentMin)?t.parentMin:0,t.parentMax=we(t.parentMax)?t.parentMax:1/0,t.SEGselections=we(t.SEGselections)?t.SEGselections:0,t.SE.forEach((e=>{let o=e.entry;const i=se(o,t.rosterEntry);let r=0;const s=t.rosterEntry.selections??{},c=Object.values(s).filter((e=>e.entryId.split(":").pop()===o.id));if(c.length>0&&(c.forEach((e=>{r+=e.quantity})),r/=t.rosterEntry.quantity),!i&&!t.hidden||r>0){let i={id:[t.path??"",e.path??"",o.id].filter((e=>e.length>0)).join(":"),label:le(o,t.rosterEntry),cost:{}};const s=pe(o,t.rosterEntry);Object.values(s).filter((e=>0!==e.value)).forEach((e=>{i.cost[e.name]=e.value*t.rosterEntry.quantity}));let c=0,l=1/0;const a=ae(o,t.rosterEntry);c=a.minQuant,l=a.maxQuant;const d=Math.max(c,t.parentMin),p=Math.min(l,t.parentMax),f=Math.min(c,r),u=Math.max(p,r),y=c===p&&c===r||u<=0;if(p<c&&console.log("Unexpected min "+c+" / max "+p+" in "+i.label),1===u){if(!t.radioGroup||t.hidden||t.SEGselections>1)i.type="check",i.checked=r>0;else if(i.type="radio",i.radioGroup=t.radioGroup,i.checked=r>0,t.newRadioGroup&&1!==d){let e={label:"None",id:t.parentSEG.id+"_NONE",cost:{},type:"radio",radioGroup:t.radioGroup,checked:0===t.SEGselections};n.children.push(e),t.newRadioGroup=!1,t.parentOpt&&(t.parentOpt.newRadioGroup=!1)}}else{i.type="number",i.min=f;let e=Math.min(l,t.parentMax-t.SEGselections+r);i.max=Math.max(r,e),i.value=r,o.merge||(i.min=r)}y||n.children.push(i)}})),n.children.length>0){if(t.subHeaders){for(let n=0;n<t.subHeaders.length;n++)o=e,i=t.subHeaders[n],o.appendChild(z("div",["text-muted","border-bottom","pl-3"])).appendChild(z("small")).textContent=i.title;t.subHeaders=[],t.parentOpt.subHeaders=[]}!function(e,t){let n=e.appendChild(z("div",["mb-2","outer-group"]));t.children.forEach((e=>{let t,o=n.appendChild(z("div"));if("check"===e.type||"radio"===e.type){o.classList.add("form-check");let n=o.appendChild(z("input","form-check-input"));n.id=e.id,"check"===e.type?n.type="checkbox":"radio"===e.type?(n.type="radio",n.name=e.radioGroup):console.log("Unexpected input type: "+e.type),e.checked&&(n.checked="checked");let i=o.appendChild(z("label","form-check-label"));i.for=e.id,i.textContent=e.label,t=i.appendChild(z("span",["small","text-muted","ml-3"]))}else if(e.type="number"){o.classList.add("d-flex"),o.classList.add("align-items-baseline");let n=o.appendChild(z("input","number-in"));n.id=e.id,n.type="number",n.step="1",["min","max","value"].forEach((t=>{n[t]=e[t]}));let i=o.appendChild(z("label",["number-in"]));i.for=e.id,i.textContent=e.label,t=i.appendChild(z("span",["small","text-muted","ml-3"]))}const i=Object.keys(e.cost);if(i.length>0){let n="(";for(let t=0;t<i.length;t++){const o=parseInt(e.cost[i[t]]);o>0&&(n+="+"),n+=o+" "+i[t],t!==i.length-1&&(n+=", ")}n+=")",t.textContent=n}}))}(e,n)}var o,i;t.SEG.forEach((n=>{n.parentOpt=t;const o=n.parentSEG,i=se(o,t.rosterEntry);n.hidden=i||t.hidden;let r={title:le(o,t.rosterEntry)},s=[t.path??"",n.path,o.id];n.path=s.filter((e=>e.length>0)).join(":");const c=he({scope:"parent",rosterLink:t.rosterEntry,id:o.id,type:"SEG",icf:!1,ics:!1});n.SEGselections=c;let l=0,a=1/0;const d=ae(o,t.rosterEntry);l=d.minQuant,a=d.maxQuant,n.parentMin=Math.max(l,t.parentMin),n.parentMax=Math.min(a,t.parentMax),we(t.radioGroup)?(n.radioGroup=t.radioGroup,n.newRadioGroup=t.newRadioGroup):1===n.parentMax&&(n.radioGroup=r.title,n.newRadioGroup=!0),n.rosterEntry=t.rosterEntry,t.subHeaders&&t.subHeaders.length>0?n.subHeaders=t.subHeaders.concat(r):n.subHeaders=[r],Ee(e,n)}))}function be(e,t,n){const o=Ue(t);t.id,o.id;let i=e.id;(e.modifiers??[]).forEach((r=>{try{let s={status:!0,repeat:1,link:r,entryLink:e,conditions:[]};we(e.import)?s.entryType=(e.link??e).type?"SE":"SEG":we(e.categoryLinks)?s.entryType="force":(s.entryType="category",i=e.targetId??e.id),"name"===r.field?(s.field="name",s.fieldType="display"):"hidden"===r.field?(s.field="hidden",s.fieldType="display"):"category"===r.field&&(s.field="category",s.fieldType="display"),Object.keys(o.catalogue.costTypes).forEach((e=>{r.field===e&&(s.field=e,s.fieldType="cost")}));const c=(e.constraints??[]).concat(e.link?.constraints??[]).filter((e=>e.id===r.field));1===c.length?(s.field=c[0].id,"min"===c[0].type?s.fieldType="min-constraint":"max"===c[0].type?s.fieldType="max-constraint":console.log("Unexpected constraint type")):c.length>1&&console.log("Modifier to "+e.name+" matched multiple constraints");const a=!0;let d=!0,p=[];(r.conditions??[]).concat(r.repeats??[]).forEach((n=>{let o=Ie(n,e,t);p.push(o),d&=o.inScope}));let f=[];(r.conditionGroups??[]).forEach((n=>{let o=Le(n,e,t);f.push(o),d&=o.inScope,0==o.conditions.length&&0==o.groups.length&&console.log("Found empty group in "+e.name+", "+e.id,o)}));const u=n&&a&&d,y=!(n||a&&d);if(we(s.field))if(u||y){f.forEach((e=>{ve(s,e,t)})),p.forEach((e=>{ve(s,e,t)})),we(t.modifiers[i])||(t.modifiers[i]=[]);let n=t.modifiers[i].push(s);const o=t.modifiers[i][n-1];if(s.conditions.forEach((e=>{e.parent=o})),s.conditions.some((e=>e.isRepeat))&&xe(s.conditions[0]),"min-constraint"===s.fieldType||"max-constraint"===s.fieldType){const n=e.targetId??e.id;let i=[l,t],r=t;for(;r.parent;)i.push(r.parent),r=r.parent;let c=[];if(i.forEach((e=>{const t=e.constraints?.[n]??[];c=c.concat(t.filter((e=>e.link.id===s.field)))})),0===c.length)console.log("Didnt find constraint for mod",s);else if(c.length>1)console.log("mod matched multiple constraints",s);else{const e=c[0];e.modifiers||(e.modifiers=[]),e.modifiers.push(o),o.constraint=e}}}else!n&&a&&d||(!n||a&&d)&&console.log("Unexpected state in "+e.id);else console.log("failed to find modifier target "+r.field)}catch(e){console.log(e)}}))}function Ie(e,t,n){const o=Ue(n);let i={obj:{status:!1,link:e,entry:t,isGroup:!1,isRepeat:!!e.repeats,count:0},inScope:!1,targetId:e.childId};if("roster"===e.scope)i.storeScope="roster",i.inScope=!0;else if("force"===e.scope)i.storeScope="force",i.inScope=!0;else if(e.scope===o.catalogue.id||e.scope===o.gstLink.id)i.storeScope="force",i.inScope=!0;else if("ancestor"===e.scope)i.storeScope="self",i.inScope=!0;else if("primary-catalogue"===e.scope)i.storeScope="self",i.inScope=!0;else if("primary-category"===e.scope)i.storeScope="self",i.inScope=!0;else if("parent"===e.scope)i.inScope=!0,n.link?.id===t.id||n.link?.targetId===t.id?i.storeScope="parent":i.storeScope="self";else if(e.scope===t.id||e.scope===t.targetId||"self"===e.scope)i.storeScope="self";else if(e.scope===n.link?.id||e.scope===n.link?.targetId)i.inScope=!0,i.storeScope="self";else{let o=!1,r=n;for(;r.parent;)r=r.parent,e.scope!==r.link?.id&&e.scope!==r.link?.targetId||(o=!0,i.storeScope="ancestral:"+Me(r).join(":"),i.inScope=!0);o||console.log("did not match condition scope "+e.scope+", from entry "+t.id)}return i}function Le(e,t,n){let o={status:!0,link:e,isGroup:!0,isRepeat:!1,type:e.type,conditions:[]},i={obj:o,inScope:"and"===e.type,storeScope:"self",targetId:"group",conditions:[],groups:[]};(e.conditionGroups??[]).forEach((e=>{let r=Le(e,t,n);i.groups.push(r),"or"===o.type?i.inScope|=r.inScope:i.inScope&=r.inScope}));let r=!1,s=!1;return(e.conditions??[]).concat(e.repeats??[]).forEach((e=>{let c=Ie(e,t,n);i.conditions.push(c),"or"===o.type?i.inScope|=c.inScope:"and"===o.type?i.inScope&=c.inScope:console.log("unexpected group type "+o.type),r|=c.inScope,s|=!c.inScope})),"or"===o.type&&r&&s&&console.log("Mixed scope group in "+t.name+", "+t.id),i}function ve(e,t,n){const o=Ue(n),i=(o.id,t.obj.isGroup);if(i)t.groups.forEach((e=>{ve(t.obj,e,n),t.obj.status&=e.obj.status})),t.conditions.forEach((e=>{ve(t.obj,e,n),t.obj.status&=e.obj.status})),"or"===t.obj.type&&(t.obj.status=0===t.obj.conditions.length,t.obj.status|=t.obj.conditions.some((e=>e.status)));else{const e=t.obj.link;if("string"==typeof e.value&&(e.value=parseInt(e.value),e.includeChildForces="true"===e.includeChildForces,e.includeChildSelections="true"===e.includeChildSelections),e.repeats&&"string"==typeof e.repeats&&(e.repeats=parseInt(e.repeats),e.roundUp="true"===e.roundUp),"primary-catalogue"===e.scope)"instanceOf"===e.type?t.obj.status=o.catalogue.id===t.targetId:"notInstanceOf"===e.type?t.obj.status=o.catalogue.id!==t.targetId:console.log("Unexpected condition type of "+e.type+" with primary-catalogue scope in ",n);else if("primary-category"===e.scope){let o="",i=n;for(;i.parent;)i.link.primeCtg&&(o=i.link.primeCtg),i=i.parent;0===o.length&&console.log("Unable to find prime category from ",t.obj),"instanceOf"===e.type?t.obj.status=o===t.targetId:"notInstanceOf"===e.type?t.obj.status=o!==t.targetId:console.log("Unexpected condition type of "+e.type+" with primary-category scope in ",n)}else if("ancestor"===e.scope){let o=n;const i=e.childId;let r=!1;for(;o.parent;){if(i===o.link.id||i===o.link.targetId)r=!0;else{(o.link.categoryLinks??[]).concat(o.link.link?.categoryLinks??[]).some((e=>e.targetId===i))&&(r=!0)}o=o.parent}"instanceOf"===e.type?t.obj.status=r:"notInstanceOf"===e.type?t.obj.status=!r:console.log("Unexpected condition type of "+e.type+" with ancestor scope in "+n.entryId)}else{let o=n;/ancestral:/.test(t.storeScope)&&(o=Re(t.storeScope.split("ancestral:").join("")));const i={scope:e.scope,rosterLink:o,id:e.childId,icf:e.includeChildForces,ics:e.includeChildSelections};"forces"===e.field&&(i.type="force"),t.obj.count=he(i),t.obj.status=Se(t.obj)}}let r;e.status&=t.obj.status,"roster"===t.storeScope?r=l:"force"===t.storeScope?r=o:"parent"===t.storeScope?r=n.parent:"self"===t.storeScope?r=n:/ancestral:/.test(t.storeScope)?r=Re(t.storeScope.split("ancestral:").join("")):console.log("Unexpected storage scope for condition ",t),we(r)||(console.log("Undefined condition storage dest from "+n.name+", "+n.link?.id),console.log(t)),we(r.conditions)||(r.conditions={}),r=r.conditions,we(r[t.targetId])||(r[t.targetId]=[]);const s=r[t.targetId];let c=s.push(t.obj);e.conditions.push(s[c-1]),i&&t.obj.conditions.forEach((e=>{e.parent=s[c-1]}))}function Se(e){const t=e.link.type,n=e.link.value,o=e.count;return e.isRepeat?Math.floor(o/n)*e.link.repeats:"instanceOf"===t?o>=1:"notInstanceOf"===t?0===o:"lessThan"===t?o<n:"atMost"===t?o<=n:"greaterThan"===t?o>n:"atLeast"===t?o>=n:"equalTo"===t?o===n:"notEqualTo"===t?o!==n:void console.log("Unexpected condition type: "+t)}function xe(e){e;let t=e.parent;const n=t.status;let o=!1,i=0;t.conditions.filter((e=>e.isRepeat)).forEach((e=>{i+=e.status}));const r=t.conditions.filter((e=>!e.isRepeat));o=t.isGroup&&"or"===t.type?r.some((e=>e.status)):!r.some((e=>!e.status)),t.status=!!o,t.repeat=(o?1:0)*i,t.isGroup&&n!=t.status&&xe(t)}function je(e,t){Object.keys(t).forEach((n=>{e[n]||(e[n]={value:0,name:t[n].name}),e[n].value+=t[n].value}))}document.addEventListener("DOMContentLoaded",(function(){console.log("page load success v0.6.2a"),console.log(l),document.getElementById("rosterAddForce").addEventListener("click",P),document.getElementById("submitForceBtn").addEventListener("click",w),document.getElementById("cancelForceBtn").addEventListener("click",q),document.getElementById("gameSelect").addEventListener("input",B),document.getElementById("forceFaction").addEventListener("input",F),document.getElementById("forceType").addEventListener("input",F),document.getElementById("rp-formarea").addEventListener("change",X),document.getElementById("LP-return").addEventListener("click",(()=>G("cp"))),document.getElementById("RP-return").addEventListener("click",(()=>G("cp"))),document.getElementById("rosterAddUnit").addEventListener("click",(()=>G("lp"))),e&&async function(){i=await Oe(o);let e='<option selected value="unselected">Available games..</option>';n.forEach((t=>{const n=i.repositories.filter((e=>e.name===t))[0];n&&n.gamesystemData?n.gamesystemData.forEach((t=>{let o=n.name+"/"+t.id;e+='<option value="'+o+'">'+t.name+"</option>"})):console.log("Didnt find "+t+" in gallery")}));document.getElementById("gameSelect").innerHTML=e}()}),!1),window.onload=function(){window.addEventListener("resize",O),Fe("i-inv")};function Ce(e){let t={};e;for(let n=0;n<e.attributes.length;n++)t[e.attributes[n].name]=e.attributes[n].value;if(e.hasChildNodes()&&e.childNodes[0].nodeType===Node.TEXT_NODE){let n=e.childNodes[0].nodeValue.trim();n.length>0&&(t.text=n,"characteristic"!==e.tagName&&(console.log("new Direct text: "+e.tagName),console.log(e)))}for(let n=0;n<e.children.length;n++){let o=e.children[n].tagName;if(y.includes(o)){t[o]=[];for(let i=0;i<e.children[n].children.length;i++)t[o].push(Ce(e.children[n].children[i]))}else t[o]=e.children[n].textContent.trim(),m.includes(o)||console.log("new orphan type: "+o)}return t}function Oe(e){return fetch(encodeURI(e)).then((e=>e.text())).then((e=>JSON.parse(e))).catch(console.log)}function Ge(e){return fetch(encodeURI(e)).then((e=>e.text())).catch(console.log)}function Be(e){return Ce((new window.DOMParser).parseFromString(e,"text/xml").children[0])}function Pe(e){let t="",n="abcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)t+=n.charAt(Math.floor(36*Math.random()));return t}function Fe(e){document.getElementById(e).classList.remove("d-none")}function qe(e){document.getElementById(e).classList.add("d-none")}function we(e){return void 0!==e}function Te(e,t){const n=e.entry??e,o=t.entry??t;return function(e,t){return(e=e.toUpperCase())<(t=t.toUpperCase())?-1:e>t?1:0}(n.link?.name??n.name,o.link?.name??o.name)}function Me(e){let t=[e.id];for(;e.parent;)e=e.parent,t.push(e.id);return t.reverse()}function Re(e){we(e.length)&&"object"!=typeof e&&(e=e.split(":"));let t=l;for(let n=0;n<e.length;n++)if(t.forces&&t.forces[e[n]])t=t.forces[e[n]];else{if(!t.selections||!t.selections[e[n]])return!1;t=t.selections[e[n]]}return t}function Ne(e,t){if(we(t.length)&&"object"!=typeof t&&0===(t=t.split(":"))[0].length)return e;let n=e;for(let o=0;o<t.length;o++)if(n.id===t[o]);else if(n.link&&n.link.id===t[o])n=n.link;else{const i=n.selectionEntries||[],r=n.selectionEntryGroups||[],s=n.entryLinks||[];let c=i.concat(r,s).filter((e=>e.id===t[o]));if(!(c.length>0))return console.log("Didnt match entry "+t[o]+" from "+n.id+", "+n.name),void console.log(t,e);n=c[0]}return n}function Ue(e){return l.forces[Me(e).shift()]}function De(e){let t=[];if(e.catalogue||e.forces)return t;let n=e.entryId.split(":");n.pop();let o="";return n[0]&&n[0]===e.parent.link?.targetId&&(o+=n.shift()),n.forEach((n=>{o.length>0&&(o+=":"),o+=n,t.push(Ne(e.parent.link,o))})),t}